{%- comment -%}
  Simple Search Bar - Um componente de pesquisa minimalista para o tema Focal
  
  Uso:
  {%- render 'simple-search-bar' -%}
  
  Dependências:
  - Usa as variáveis CSS do tema Focal
  - Compatível com o sistema de ícones do tema
{%- endcomment -%}

<div class="simple-search-container">
  <form action="{{ routes.search_url }}" method="get" role="search" class="simple-search-form">
    <input type="hidden" name="type" value="product">
    <input type="hidden" name="options[prefix]" value="last">
    <input type="hidden" name="options[unavailable_products]" value="{{ settings.search_unavailable_products }}">
    
    <div class="simple-search-input-wrapper">
      <input 
        class="simple-search-input" 
        type="text" 
        name="q" 
        autocomplete="off" 
        autocorrect="off"
        aria-label="{{ 'search.general.search_placeholder' | t }}" 
        placeholder="{{ 'search.general.search_placeholder' | t }}"
        data-live-search="true"
      >
      
      <button type="submit" class="simple-search-submit" aria-label="Buscar">
        {%- render 'icon' with 'header-search' -%}
      </button>
      
      <button type="button" class="simple-search-clear" aria-label="Limpar" style="display: none;">
        {%- render 'icon' with 'close' -%}
      </button>
    </div>
    
    <div class="simple-search-results" style="display: none;">
      <div class="simple-search-loading">
        <div class="simple-search-spinner"></div>
      </div>
      <div class="simple-search-results-content"></div>
    </div>
  </form>
</div>

<style>
  /* Estilos para a barra de pesquisa simples */
  .simple-search-container {
    width: 100%; /* Usa 100% da largura disponível do container pai */
    max-width: none;
    margin: 0 auto;
    position: relative;
  }
  
  .simple-search-form {
    width: 100%;
    position: relative;
  }
  
  .simple-search-input-wrapper {
    display: flex;
    align-items: center;
    position: relative;
    border-radius: 8px;
    border: 1px solid rgba(var(--header-border-color), 0.2);
    background-color: {{ section.settings.pesquisabackgroud }};
    transition: all 0.2s ease;
    overflow: hidden;
    height: auto; /* Permite que o container se ajuste ao tamanho do input */
  }
  
  .simple-search-input-wrapper:focus-within {
    border-color: rgba(var(--header-text-color), 0.4);
    box-shadow: 0 0 0 1px rgba(var(--header-text-color), 0.1);
  }
  
  .simple-search-input {
    flex: 1;
    border: none;
    background: transparent;
    padding: 12px 15px;
    font-size: 15px;
    color: {{ section.settings.pesquisatexto }};
    width: 100%;
    outline: none;
    /* A altura é controlada pelo header, mas mantemos o padding como fallback */
    min-height: 40px; 
    line-height: 1.2;
  }
  
  .simple-search-input::placeholder {
    color:{{ section.settings.pesquisatexto }};
  }
  
  .simple-search-submit {
    background: transparent;
    border: none;
    padding: 0 15px;
    cursor: pointer;
    color: {{ section.settings.pesquisatexto }};
    display: flex;
    align-items: center;
    justify-content: center;
    transition: opacity 0.2s ease;
  }
  
  .simple-search-submit:hover {
    opacity: 0.8;
  }
  
  .simple-search-clear {
    background: transparent;
    border: none;
    padding: 0 15px;
    cursor: pointer;
    color: {{ section.settings.pesquisatexto }};
    display: flex;
    align-items: center;
    justify-content: center;
    transition: opacity 0.2s ease;
  }
  
  .simple-search-clear:hover {
    opacity: 0.8;
  }
  
  /* Resultados da pesquisa ao vivo */
  .simple-search-results {
    position: absolute;
    top: calc(100% + 5px);
    left: 0;
    right: 0;
    background-color: {{ section.settings.pesquisabackgroud }};
    border-radius: 10px;
    border: 1px solid rgba(0, 0, 0, 0.1);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    z-index: 1000;
    max-height: 400px;
    overflow-y: auto;
  }
  
  .simple-search-loading {
    padding: 20px;
    text-align: center;
  }
  
  .simple-search-spinner {
    width: 20px;
    height: 20px;
    border: 2px solid rgba(0, 0, 0, 0.1);
    border-top-color: #333333;
    border-radius: 50%;
    margin: 0 auto;
    animation: simple-search-spin 0.6s linear infinite;
  }
  
  @keyframes simple-search-spin {
    to { transform: rotate(360deg); }
  }
  
  .simple-search-results-content {
    padding: 10px 0;
  }
  
  .simple-search-result-item {
    display: flex;
    align-items: center;
    padding: 8px 15px;
    text-decoration: none;
    color: #333333;
    transition: background-color 0.2s ease;
  }
  
  .simple-search-result-item:hover {
    background-color: #f5f5f5;
  }
  
  .simple-search-result-image {
    width: 40px;
    height: 40px;
    object-fit: cover;
    margin-right: 10px;
    border-radius: 4px;
  }
  
  .simple-search-result-info {
    flex: 1;
  }
  
  .simple-search-result-title {
    font-size: 14px;
    margin: 0 0 4px;
    font-weight: 500;
  }
  
  .simple-search-result-price {
    font-size: 13px;
    color: #666666;
  }
  
  .simple-search-no-results {
    padding: 15px;
    text-align: center;
    color: #666666;
    font-size: 14px;
  }
  
  .simple-search-view-all {
    display: block;
    text-align: center;
    padding: 10px 15px;
    border-top: 1px solid #eeeeee;
    color: #333333;
    font-size: 14px;
    font-weight: 500;
    text-decoration: none;
  }
  
  .simple-search-view-all:hover {
    background-color: #f5f5f5;
  }
  
  /* Responsividade */
  @media screen and (max-width: 740px) {
    .simple-search-container {
      width: 100%; /* Usa 100% da largura disponível do container pai */
      margin: 0 auto;
    }
    
    .simple-search-input-wrapper {
      border-radius: 10px;
      height: auto; /* Mantém altura automática para ajustar ao conteúdo */
    }
    
    .simple-search-input {
      padding: 10px 12px;
      font-size: 13px;
      min-height: 30px; /* Altura mínima menor para dispositivos móveis */
    }
    
    .simple-search-submit,
    .simple-search-clear {
      padding: 0 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  }

  /* Force dynamic colors on the content injected from predictive-search section */
  .simple-search-results .product-item-meta__title,
  .simple-search-results .product-item-meta__vendor,
  .simple-search-results .price,
  .simple-search-results .heading,
  .simple-search-results a,
  .simple-search-results p,
  .simple-search-results span,
  .simple-search-results .predictive-search__article-title,
  .simple-search-results .predictive-search__linklist-link {
    color: {{ section.settings.pesquisatexto }} !important;
  }

  .simple-search-results .price--compare {
    opacity: 0.7;
  }

</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const searchForms = document.querySelectorAll('.simple-search-form');
    
    searchForms.forEach(form => {
      const input = form.querySelector('.simple-search-input');
      const clearButton = form.querySelector('.simple-search-clear');
      const resultsContainer = form.querySelector('.simple-search-results');
      const resultsContent = form.querySelector('.simple-search-results-content');
      const loadingIndicator = form.querySelector('.simple-search-loading');
      
      // Mostrar/ocultar botão de limpar
      input.addEventListener('input', function() {
        clearButton.style.display = this.value.length > 0 ? 'flex' : 'none';
        
        // Se a pesquisa ao vivo estiver habilitada
        if (this.dataset.liveSearch && this.value.length >= 3) {
          performLiveSearch(this.value);
        } else if (resultsContainer) {
          resultsContainer.style.display = 'none';
        }
      });
      
      // Botão de limpar
      if (clearButton) {
        clearButton.addEventListener('click', function() {
          input.value = '';
          input.focus();
          clearButton.style.display = 'none';
          if (resultsContainer) {
            resultsContainer.style.display = 'none';
          }
        });
      }
      
      // Pesquisa ao vivo
      let searchTimeout;
      function performLiveSearch(query) {
        if (!resultsContainer) return;
        
        clearTimeout(searchTimeout);
        
        if (query.length < 3) {
          resultsContainer.style.display = 'none';
          return;
        }
        
        searchTimeout = setTimeout(() => {
          resultsContainer.style.display = 'block';
          
          if (loadingIndicator) {
            loadingIndicator.style.display = 'block';
          }
          
          if (resultsContent) {
            resultsContent.innerHTML = '';
          }
          
          // Fazer a requisição de pesquisa usando Section Rendering API
          // Isso busca o HTML renderizado pela section 'predictive-search'
          // Use window.themeVariables.routes if available, otherwise fallback or checking generic routes
          const predictiveSearchUrl = (window.themeVariables && window.themeVariables.routes && window.themeVariables.routes.predictiveSearchUrl) || '/search/suggest';
          
          fetch(`${predictiveSearchUrl}?q=${encodeURIComponent(query)}&section_id=predictive-search`)
            .then(response => {
              if (!response.ok) {
                var error = new Error(response.statusText);
                error.code = response.status;
                throw error;
              }
              return response.text();
            })
            .then(text => {
              if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
              }
              
              // Parse the HTML string into a document
              const resultsMarkup = new DOMParser().parseFromString(text, 'text/html').querySelector('#shopify-section-predictive-search').innerHTML;
              resultsContent.innerHTML = resultsMarkup;
              
              if (!resultsMarkup || resultsMarkup.trim() === '') {
                 resultsContent.innerHTML = `
                  <div class="simple-search-no-results">
                    Nenhum resultado encontrado
                  </div>
                `;
              }
            })
            .catch(error => {
              if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
              }
              
              resultsContent.innerHTML = `
                <div class="simple-search-no-results">
                  Erro ao buscar resultados
                </div>
              `;
              console.error('Erro na pesquisa:', error);
            });
        }, 300);
      }
      
      // Fechar resultados ao clicar fora
      document.addEventListener('click', function(event) {
        if (!form.contains(event.target) && resultsContainer) {
          resultsContainer.style.display = 'none';
        }
      });
      
      // Evitar que o clique nos resultados feche o container
      if (resultsContainer) {
        resultsContainer.addEventListener('click', function(event) {
          event.stopPropagation();
        });
      }
    });
  });
</script>